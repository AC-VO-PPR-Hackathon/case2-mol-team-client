<script src="https://unpkg.com/@tensorflow/tfjs-core/dist/tf-core.js"></script>
<script src="https://unpkg.com/@tensorflow/tfjs-converter/dist/tf-converter.js"></script>

<script src="https://unpkg.com/@tensorflow/tfjs-backend-cpu/dist/tf-backend-cpu.js"></script>
<script src="https://unpkg.com/@tensorflow/tfjs-backend-webgl/dist/tf-backend-webgl.js"></script>

<script src="https://unpkg.com/@tensorflow-models/handpose/dist/handpose.js"></script>

<video id="video" style="width: 600px; height: 600px; transform: scaleX(-1); position: absolute"></video>
<canvas id="canvas" width="600" height="600" style="transform: scaleX(-1); position: absolute"></canvas>

<script>

	function initCanvas() {
		const canvasElement = document.getElementById('canvas')
		const context = canvasElement.getContext('2d')
		return context
	}

	function draw(ctx, predictions) {
		ctx.clearRect(0,0,600,600)
		ctx.strokeStyle = 'blue'
		ctx.beginPath();
		ctx.moveTo(0,0);
		ctx.lineTo(600,600);
		ctx.moveTo(0,600);
		ctx.lineTo(600,0);
		ctx.stroke();
	}

	async function initVideo() {

		const mediaStream = await navigator.mediaDevices.getUserMedia({
			audio: false,
			video: {
				height: 600,
				width: 600,
				facingMode: "user",
			}
		})

		const videoElement = document.getElementById('video')
		videoElement.srcObject = mediaStream
		
		await new Promise(done => videoElement.onloadedmetadata = done)
		
		videoElement.play()

		return videoElement
	}

	function X( coords ) {
		return coords[0][0]
	} 

	function Y( coords ) {
		return coords[0][1]
	} 

	async function handleGesures(predictions) {

		if (predictions.length == 0) {
			console.log( 'wait...' )
			return
		}

		console.info(predictions)
		for (pred of predictions) {

			const index = pred.annotations.indexFinger
			const palm = pred.annotations.palmBase
			const thumb = pred.annotations.thumb

			if (X(index) > X(palm) && Y(thumb) < Y(palm)) {
				console.log('left')
			}

			if (X(index) < X(palm) && Y(thumb) < Y(palm)) {
				console.log('right')
			}
		}

	}

	async function main() {

		const videoElement = await initVideo()
		const context = initCanvas()
		const model = await handpose.load()

		while (true) {
			await new Promise(requestAnimationFrame)
			const predictions = await model.estimateHands(videoElement)
			await handleGesures(predictions)
			draw(context,predictions)
		}

	}
	main()

</script>
