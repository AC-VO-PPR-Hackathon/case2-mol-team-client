<script src="https://unpkg.com/@tensorflow/tfjs-core/dist/tf-core.js"></script>
<script src="https://unpkg.com/@tensorflow/tfjs-converter/dist/tf-converter.js"></script>

<script src="https://unpkg.com/@tensorflow/tfjs-backend-cpu/dist/tf-backend-cpu.js"></script>
<script src="https://unpkg.com/@tensorflow/tfjs-backend-webgl/dist/tf-backend-webgl.js"></script>

<script src="https://unpkg.com/@tensorflow-models/handpose/dist/handpose.js"></script>

<video id="video" style="width: 600px; height: 600px; transform: scaleX(-1)">


<script>

	async function initVideo() {

		const mediaStream = await navigator.mediaDevices.getUserMedia({
			audio: false,
			video: {
				height: 600,
				width: 600,
				facingMode: "user",
			}
		})

		const videoElement = document.getElementById('video')
		videoElement.srcObject = mediaStream
		
		await new Promise(done => videoElement.onloadedmetadata = done)
		
		videoElement.play()

		return videoElement
	}

	function bottomX( coords ) {
    return coords[0][0]
  }

    function topX( coords ) {
    return coords[3][0]
  } 

    function bottomY( coords ) {
    return coords[0][1]
  }

    function topY( coords ) {
    return coords[3][1]
  }

  var treshold = 4

  	function isUp(finger) {
		const d_x = topX(finger) - bottomX(finger)
		const d_y = topY(finger) - bottomY(finger)
		if (d_x != 0) {
			if (Math.abs(d_y/d_x) > treshold) {
				if(d_y < 0) {
					return true
				}
			}
		}
		return false
  	}

	function isDown(finger) {
		const d_x = topX(finger) - bottomX(finger)
		const d_y = topY(finger) - bottomY(finger)
		if (d_x != 0) {
			if (Math.abs(d_y/d_x) > treshold) {
				if(d_y > 0) {
					return true
				}
			}
		}
		return false
  	}

	function isRight(finger) {
		const d_x = topX(finger) - bottomX(finger)
		const d_y = topY(finger) - bottomY(finger)
		if (d_y != 0) {
				if (Math.abs(d_x/d_y) > treshold) {
					if (d_x < 0){
						return true
				}
			}
		}
		return false
	}

	function isLeft(finger) {
		const d_x = topX(finger) - bottomX(finger)
		const d_y = topY(finger) - bottomY(finger)
		if (d_y != 0) {
				if (Math.abs(d_x/d_y) > treshold) {
					if (d_x > 0){
						return true
				}
			}
		}
		return false
	}

	async function handleGesures(predictions) {

		if (predictions.length == 0) {
			console.log( 'wait...' )
			return
		}

		for (pred of predictions) {

			const index = pred.annotations.indexFinger
			const palm = pred.annotations.palmBase
			const thumb = pred.annotations.thumb
			const middle = pred.annotations.middleFinger

			if (isUp(index) & isUp(middle)) {console.log("peace")}
			else if (isUp(thumb)) {console.log("thumb up")}
			else if (isRight(thumb)) {console.log("thumb right")}
			else if (isDown(index)) {console.log("index down")}
			else if (isLeft(index)) {console.log("index left")}


		}
	}

	async function main() {

		const videoElement = await initVideo()
		const model = await handpose.load()

		while (true) {
			await new Promise(requestAnimationFrame)
			const predictions = await model.estimateHands(videoElement)
			await handleGesures(predictions)
		}

	}
	main()

</script>