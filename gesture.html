<script src="https://unpkg.com/@tensorflow/tfjs-core/dist/tf-core.js"></script>
<script src="https://unpkg.com/@tensorflow/tfjs-converter/dist/tf-converter.js"></script>

<script src="https://unpkg.com/@tensorflow/tfjs-backend-cpu/dist/tf-backend-cpu.js"></script>
<script src="https://unpkg.com/@tensorflow/tfjs-backend-webgl/dist/tf-backend-webgl.js"></script>

<script src="https://unpkg.com/@tensorflow-models/handpose/dist/handpose.js"></script>

<video id="video" style="width: 600px; height: 600px; transform: scaleX(-1); position: absolute"></video>
<canvas id="canvas" width="600" height="600" style="transform: scaleX(-1); position: absolute"></canvas>

<script>

	function initCanvas() {
		const canvasElement = document.getElementById('canvas')
		const context = canvasElement.getContext('2d')
		return context
	}

	function draw_line(ctx, dot_1, dot_2){
		ctx.strokeStyle = 'blue'

		ctx.beginPath();
		ctx.moveTo(X(dot_1), Y(dot_1))
		ctx.lineTo(X(dot_2), Y(dot_2))

		ctx.stroke();
	}

	function draw_dot(ctx, dot){
		ctx.fillStyle = "red"

		ctx.beginPath();
		ctx.arc(X(dot), Y(dot), 3, 0, Math.PI*2, false)
		ctx.fill()
	}

	function draw_all_dot(ctx, dots){
		for (dot of dots){
			draw_dot(ctx, dot)
		}
	}

	function draw(ctx, predictions) {
		ctx.clearRect(0,0,600,600)

		for (pred of predictions) {
			const index = pred.annotations.indexFinger
			const thumb = pred.annotations.thumb
			const middle = pred.annotations.middleFinger
			const ringFinger = pred.annotations.ringFinger
			const pinky = pred.annotations.pinky

			const palm = pred.annotations.palmBase

			draw_all_dot(ctx, palm)
			draw_line(ctx, palm[0], index[0])
			draw_line(ctx, palm[0], thumb[0])
			draw_line(ctx, palm[0], middle[0])
			draw_line(ctx, palm[0], ringFinger[0])
			draw_line(ctx, palm[0], pinky[0])

			draw_all_dot(ctx, index)
			draw_line(ctx, index[0], index[1])
			draw_line(ctx, index[1], index[2])
			draw_line(ctx, index[2], index[3])

			draw_all_dot(ctx, thumb)
			draw_line(ctx, thumb[0], thumb[1])
			draw_line(ctx, thumb[1], thumb[2])
			draw_line(ctx, thumb[2], thumb[3])

			draw_all_dot(ctx, middle)
			draw_line(ctx, middle[0], middle[1])
			draw_line(ctx, middle[1], middle[2])
			draw_line(ctx, middle[2], middle[3])

			draw_all_dot(ctx, ringFinger)
			draw_line(ctx, ringFinger[0], ringFinger[1])
			draw_line(ctx, ringFinger[1], ringFinger[2])
			draw_line(ctx, ringFinger[2], ringFinger[3])

			draw_all_dot(ctx, pinky)
			draw_line(ctx, pinky[0], pinky[1])
			draw_line(ctx, pinky[1], pinky[2])
			draw_line(ctx, pinky[2], pinky[3])
		}

	}

	async function initVideo() {

		const mediaStream = await navigator.mediaDevices.getUserMedia({
			audio: false,
			video: {
				height: 600,
				width: 600,
				facingMode: "user",
			}
		})

		const videoElement = document.getElementById('video')
		videoElement.srcObject = mediaStream
		
		await new Promise(done => videoElement.onloadedmetadata = done)
		
		videoElement.play()

		return videoElement
	}

	function X( coords ) {
		return coords[0]
	} 

	function Y( coords ) {
		return coords[1]
	}

	function bottomX( coords ) {
    return coords[0][0]
  }

    function topX( coords ) {
    return coords[3][0]
  } 

    function bottomY( coords ) {
    return coords[0][1]
  }

    function topY( coords ) {
    return coords[3][1]
  }

  function jointCtg(lowerJoint, upperJoint) {
    dx = lowerJoint[0] - upperJoint[0]
    dy = lowerJoint[1] > upperJoint[1]
    return dx / dy
  }


  var treshold = 4

  	function isUp(finger) {
		const d_x = topX(finger) - bottomX(finger)
		const d_y = topY(finger) - bottomY(finger)
		if (d_x != 0) {
			if (Math.abs(d_y/d_x) > treshold) {
				if(d_y < 0) {
					return true
				}
			}
		}
		return false
  	}

	function isDown(finger) {
		const d_x = topX(finger) - bottomX(finger)
		const d_y = topY(finger) - bottomY(finger)
		if (d_x != 0) {
			if (Math.abs(d_y/d_x) > treshold) {
				if(d_y > 0) {
					return true
				}
			}
		}
		return false
  	}

	function isRight(finger) {
		const d_x = topX(finger) - bottomX(finger)
		const d_y = topY(finger) - bottomY(finger)
		if (d_y != 0) {
				if (Math.abs(d_x/d_y) > treshold) {
					if (d_x < 0){
						return true
				}
			}
		}
		return false
	}

	function isLeft(finger) {
		const d_x = topX(finger) - bottomX(finger)
		const d_y = topY(finger) - bottomY(finger)
		if (d_y != 0) {
				if (Math.abs(d_x/d_y) > treshold) {
					if (d_x > 0){
						return true
				}
			}
		}
		return false
  }
  
  function isThumbUp(thumb, finger1, finger2, finger3, finger4) {
    let x = 0
    let y = 1
    let cnt = 0
    for  (let joint = 0; joint < thumb.length-1; joint++) {
      lowerJoint = thumb[joint]
      upperJoint = thumb[joint+1]
      if (lowerJoint[y] > upperJoint[y] && jointCtg(lowerJoint, upperJoint) <= 0.8) {
        cnt++
      }
    }
    if ((cnt == 3) && !isUp(finger1) && !isUp(finger2) && !isUp(finger3) && !isUp(finger4)){return true}
    return false
  }

  function tan(finger) {
    dx = topX(finger) - bottomX(finger)
    dy = topY(finger) - bottomY(finger)
    return dy / dx
  }

  function areParallel(finger1, finger2) {
    if (Math.abs(tan(finger1) - tan(finger2)) < 0.4) {
      return true
    }
    return false
  }

  function isSpread(finger) {
    let x = 0
    let y = 1
    let cnt = 0
    for  (let joint = 0; joint < finger.length-1; joint++) {
      lowerJoint = finger[joint]
      upperJoint = finger[joint+1]
      if (lowerJoint[y] > upperJoint[y] && jointCtg(lowerJoint, upperJoint) <= 0.8) {
        cnt++
      }
    }
    if (cnt == 3) {
      return true
    }
    return false
  }

  function isPalm(finger1, finger2, finger3, finger4) {
    if (isUp(finger1) && isUp(finger2) && isUp(finger3) && isUp(finger4)) {
      // && areParallel(finger1, finger2) && areParallel(finger2, finger3) && areParallel(finger3, finger4)
      return true
    }
    return false
  }

  function isPeace(thumb, index, middle, ringfinger, pinky) {
    if (isSpread(index) && isSpread(middle) && !isUp(thumb)) {
      return true
    }
    return false
  }

	const gestures = {
		forward() { console.log('forward'); prev_cmd = 'forward'; start_time = Date.now() },
		backward() { console.log('backward'); prev_cmd = 'backward'; start_time = Date.now() },
		enter() { console.log('enter'); prev_cmd = 'enter'; start_time = Date.now() },
		exit() { console.log('exit'); prev_cmd = 'exit'; start_time = Date.now() },
		search() { console.log('search'); prev_cmd = 'search'; start_time = Date.now() },
}

	let prev_cmd = 'start'
	let start_time = 0

	function check_cmd(prev_cmd, current_cmd){
		if (prev_cmd != current_cmd){
			return true
		}
		if (prev_cmd == current_cmd && (Date.now() - start_time) > 1000){
			return true
		}
		return false
	}

	function isRightHand(index, palm, thumb){
		return X(index[0]) > X(palm[0]) && Y(thumb[0]) < Y(palm[0])
	}

	function isLeftHand(index, palm, thumb){
		return X(index[0]) < X(palm[0]) && Y(thumb[0]) < Y(palm[0])
	}

	async function handleGesures(predictions) {

		if (predictions.length == 0) {
			console.log( 'wait...' )
			return
		}

		for (pred of predictions) {

      const palm = pred.annotations.palmBase
      const index = pred.annotations.indexFinger
      const thumb = pred.annotations.thumb
      const middle = pred.annotations.middleFinger
      const ringfinger = pred.annotations.ringFinger
      const pinky = pred.annotations.pinky

      if (isPalm(index, middle, ringfinger, pinky) && isLeftHand(index, palm, thumb) && check_cmd(prev_cmd, 'backward')) {gestures.backward()}
      	else if (isRightHand(index, palm, thumb) && isUp(index) && isUp(middle) && !isSpread(ringfinger) && !isSpread(pinky) && check_cmd(prev_cmd, 'exit')){gestures.exit()}
			else if (isThumbUp(thumb, index, middle, ringfinger, pinky) && check_cmd(prev_cmd, 'enter')) {gestures.enter()}
				else if (isPalm(index, middle, ringfinger, pinky) && isRightHand(index, palm, thumb) && check_cmd(prev_cmd, 'forward')) {gestures.forward()}


		}
}

	async function main() {

		const videoElement = await initVideo()
		const context = initCanvas()
		const model = await handpose.load()

		while (true) {
			await new Promise(requestAnimationFrame)
			const predictions = await model.estimateHands(videoElement)
			await handleGesures(predictions)
			draw(context,predictions)
		}

	}
	main()

</script>
